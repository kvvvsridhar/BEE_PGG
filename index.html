<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Goods Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        /* Custom styles for the game board */
        .game-card {
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 900px;
            margin: 2rem auto;
            position: relative;
        }

        .input-field {
            border-radius: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            width: 100%;
            transition: all 0.2s ease-in-out;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-danger {
            background-color: #ef4444;
            color: #fff;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-success {
            background-color: #10b981;
            color: #fff;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        .btn:disabled {
            background-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="game-container" class="game-card w-full">
        <!-- Loader and Status Messages -->
        <div id="loading-screen" class="flex flex-col items-center justify-center p-8 text-center">
            <div class="loader mb-4"></div>
            <p id="status-message" class="text-lg text-gray-700">Initializing app...</p>
        </div>

        <!-- Host and Player UI will be rendered here dynamically -->
        <div id="game-ui" class="hidden"></div>
    </div>

    <!-- Modals for dialogs -->
    <div id="modal-container"
        class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl max-w-sm w-full mx-2 text-center">
            <h3 id="modal-title" class="text-xl font-bold text-gray-900 mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="modal-confirm" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>


    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        setLogLevel('debug');

        // Safely access global variables to avoid ReferenceError
        let appId = 'default-app-id';
        let firebaseConfig = {
            apiKey: "AIzaSyDIvu7hdyw2ibllu1p_q2hQgoHa5kCjz7E",
            authDomain: "public-goods-game-4e6ad.firebaseapp.com",
            projectId: "public-goods-game-4e6ad",
            storageBucket: "public-goods-game-4e6ad.firebasestorage.app",
            messagingSenderId: "807192829857",
            appId: "1:807192829857:web:33f291254b5d6c360fb5e0"
        };
        let initialAuthToken = '';

        if (typeof __app_id !== 'undefined') {
            appId = __app_id;
        }
        if (typeof __firebase_config !== 'undefined') {
            try {
                // If a valid config is provided by the environment, use it
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Failed to parse firebaseConfig from environment. Using hardcoded values.");
            }
        }
        if (typeof __initial_auth_token !== 'undefined') {
            initialAuthToken = __initial_auth_token;
        }

        // UI Elements
        const loadingScreen = document.getElementById('loading-screen');
        const statusMessage = document.getElementById('status-message');
        const gameUI = document.getElementById('game-ui');
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm');

        // Global variables for Firebase
        let app;
        let db;
        let auth;
        let userId;

        // Game State
        const state = {
            isHost: false,
            game: null,
            players: [],
            myContribution: null,
            accumulatedPayoff: 0,
            isRoundActive: false,
            gameId: 'public-goods-game' // Use a static ID for the single game document
        };

        // Initialize Firebase
        function initializeFirebase() {
            try {
                // Validate Firebase configuration before initializing
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error("Firebase API key is missing or invalid.");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated with ID:", userId);
                        statusMessage.textContent = 'Authenticated. Setting up game...';
                        await setupGame();
                    } else {
                        statusMessage.textContent = 'Signing in...';
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (authError) {
                            console.error("Authentication failed:", authError);
                            statusMessage.textContent = `Authentication failed. Check the console for details.`;
                            return; // Stop execution if auth fails
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                statusMessage.textContent = `Error initializing Firebase: ${error.message}`;
            }
        }

        async function setupGame() {
            if (!userId) {
                console.error("setupGame called without a valid user ID.");
                statusMessage.textContent = 'Authentication failed. Please refresh the page.';
                return;
            }
            try {
                const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${state.gameId}`);
                const gameDocSnap = await getDoc(gameDocRef);

                if (!gameDocSnap.exists()) {
                    // Host sets up the game initially
                    state.isHost = true;
                    statusMessage.textContent = 'Welcome, Host. Setting up new game...';
                    await setDoc(gameDocRef, {
                        hostId: userId,
                        isRoundActive: false,
                        round: 0,
                        gameParams: { e: 10, m: 2, groupSize: 4 }
                    });
                } else {
                    const gameData = gameDocSnap.data();
                    state.isHost = gameData.hostId === userId;
                }

                loadingScreen.classList.add('hidden');
                gameUI.classList.remove('hidden');

                // Start real-time listeners
                await setupListeners();

            } catch (error) {
                console.error("Setup error:", error);
                statusMessage.textContent = `Setup error: ${error.message}`;
            }
        }

        async function setupListeners() {
            const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${state.gameId}`);
            const playersColRef = collection(db, `/artifacts/${appId}/public/data/players`);
            
            if (!userId) {
                console.error("Cannot set up listeners without a user ID.");
                return;
            }

            onSnapshot(gameDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.game = docSnap.data();
                    state.isRoundActive = state.game.isRoundActive;
                    renderUI();
                }
            });

            onSnapshot(playersColRef, (querySnapshot) => {
                state.players = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const me = state.players.find(p => p.id === userId);
                if (me) {
                    state.myContribution = me.contributions?.[state.game?.round] || -1; // Use -1 to denote not-yet-contributed
                    state.accumulatedPayoff = me.accumulatedPayoff || 0;
                }
                renderUI();
            });
        }

        function renderUI() {
            if (state.isHost) {
                renderHostUI();
            } else {
                renderPlayerUI();
            }
        }

        // --- Host UI Logic ---
        function renderHostUI() {
            if (!state.game) return;
            const groups = groupBy(state.players, 'group');
            const sortedGroupKeys = Object.keys(groups).sort();
            const minGroupTotal = calculateMinGroupTotal(groups);
            const isEveryoneReady = state.players.every(p => p.contributions?.[state.game.round] !== -1);
            const playerMultipleOfGroupSize = state.players.length % state.game.gameParams.groupSize === 0;

            let playersTableHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Player</th>
                                <th class="py-3 px-6 text-left">Group</th>
                                <th class="py-3 px-6 text-center">Round Contribution</th>
                                <th class="py-3 px-6 text-center">Round Payoff</th>
                                <th class="py-3 px-6 text-center">Total Payoff</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
            `;
            state.players.forEach(p => {
                const roundContribution = p.contributions?.[state.game.round] || 0;
                const roundPayoff = p.payoffs?.[state.game.round] || 0;
                playersTableHTML += `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6 text-left whitespace-nowrap">${p.name}</td>
                        <td class="py-3 px-6 text-left">${p.group}</td>
                        <td class="py-3 px-6 text-center">${roundContribution}</td>
                        <td class="py-3 px-6 text-center">${roundPayoff.toFixed(2)}</td>
                        <td class="py-3 px-6 text-center">${p.accumulatedPayoff.toFixed(2)}</td>
                    </tr>
                `;
            });
            playersTableHTML += `</tbody></table></div>`;

            let groupsTableHTML = `
                <div class="mt-8 overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Group</th>
                                <th class="py-3 px-6 text-center">Total Contribution</th>
                                <th class="py-3 px-6 text-center">Group Size</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
            `;
            sortedGroupKeys.forEach(groupName => {
                const groupMembers = groups[groupName];
                const total = groupMembers.reduce((sum, p) => sum + (p.contributions?.[state.game.round] || 0), 0);
                groupsTableHTML += `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6 text-left">${groupName}</td>
                        <td class="py-3 px-6 text-center">${total}</td>
                        <td class="py-3 px-6 text-center">${groupMembers.length}</td>
                    </tr>
                `;
            });
            groupsTableHTML += `</tbody></table></div>`;

            gameUI.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8">
                    <h1 class="text-3xl font-bold mb-2 text-center">Host Dashboard</h1>
                    <p class="text-gray-600 mb-8 text-center">Manage the game and view real-time data.</p>
                    
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-6 w-full max-w-lg" role="alert">
                        <p class="font-bold">Share This Link</p>
                        <p class="text-sm">Give participants this page's URL to join the game.</p>
                    </div>

                    <div class="flex flex-wrap gap-4 mb-8">
                        <div class="bg-purple-100 text-purple-800 text-sm font-medium px-4 py-2 rounded-full">Round: ${state.game.round}</div>
                        <div class="bg-green-100 text-green-800 text-sm font-medium px-4 py-2 rounded-full">Players: ${state.players.length}</div>
                        <div class="bg-yellow-100 text-yellow-800 text-sm font-medium px-4 py-2 rounded-full">Game Status: ${state.isRoundActive ? 'Active' : 'Awaiting start'}</div>
                        ${minGroupTotal !== null ? `<div class="bg-red-100 text-red-800 text-sm font-medium px-4 py-2 rounded-full">Min. Group Pool: ${minGroupTotal}</div>` : ''}
                    </div>

                    <div class="bg-gray-100 p-6 rounded-lg mb-8 w-full">
                        <h2 class="text-xl font-bold mb-4">Game Parameters</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="param-e" class="block text-gray-700 font-medium mb-1">Endowment ($e$)</label>
                                <input type="number" id="param-e" class="input-field" min="1" value="${state.game.gameParams.e}">
                            </div>
                            <div>
                                <label for="param-m" class="block text-gray-700 font-medium mb-1">Multiplier ($m$)</label>
                                <input type="number" id="param-m" class="input-field" min="1" step="0.1" value="${state.game.gameParams.m}">
                            </div>
                            <div>
                                <label for="param-group-size" class="block text-gray-700 font-medium mb-1">Group Size</label>
                                <input type="number" id="param-group-size" class="input-field" min="2" value="${state.game.gameParams.groupSize}">
                            </div>
                        </div>
                        <div class="mt-4 flex justify-center">
                            <button id="save-params-btn" class="btn btn-primary">Save Parameters</button>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 mb-8 w-full justify-center">
                        <button id="start-round-btn" class="btn btn-success" ${state.isRoundActive || !playerMultipleOfGroupSize ? 'disabled' : ''}>${state.game.round === 0 ? 'Start Game' : 'Start Next Round'}</button>
                        <button id="end-round-btn" class="btn btn-primary" ${!state.isRoundActive || !isEveryoneReady ? 'disabled' : ''}>End Round</button>
                        <button id="reset-game-btn" class="btn btn-danger">Reset Game</button>
                    </div>
                    ${!playerMultipleOfGroupSize ? `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6 w-full" role="alert"><p>Cannot start game. Total players must be a multiple of the group size.</p></div>` : ''}
                    ${state.isRoundActive && !isEveryoneReady ? `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg mb-6 w-full" role="alert"><p>Waiting for all players to submit their contributions...</p></div>` : ''}

                    <div class="w-full">
                        <h2 class="text-xl font-bold mb-4">Player & Group Data</h2>
                        ${playersTableHTML}
                        ${groupsTableHTML}
                    </div>
                </div>
            `;
            document.getElementById('start-round-btn').addEventListener('click', startRound);
            document.getElementById('end-round-btn').addEventListener('click', endRound);
            document.getElementById('reset-game-btn').addEventListener('click', resetGame);
            document.getElementById('save-params-btn').addEventListener('click', saveGameParams);
        }

        // --- Player UI Logic ---
        function renderPlayerUI() {
            if (!state.game) return;
            const groups = groupBy(state.players, 'group');
            const myData = state.players.find(p => p.id === userId);
            const myGroup = myData ? myData.group : 'Not Assigned';
            const myGroupMembers = groups[myGroup] || [];
            
            const isRegistered = myData && myData.name && myData.group;
            
            // Check if player has made a contribution in the current round
            const myContribution = myData && myData.contributions && myData.contributions[state.game.round] !== undefined
                ? myData.contributions[state.game.round]
                : -1;
            
            // Get last round's payoff and group info
            const lastRound = state.game.round > 0 ? state.game.round - 1 : 0;
            const lastRoundPayoff = myData && myData.payoffs?.[lastRound] || 0;
            const myLastGroupContribution = myGroupMembers.reduce((sum, p) => sum + (p.contributions?.[lastRound] || 0), 0);
            const minOtherGroupTotalLastRound = calculateMinGroupTotal(groups, myGroup, lastRound);


            let mainContentHTML = '';
            if (!isRegistered) {
                mainContentHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-center">Join the Game</h2>
                        <p class="text-center text-gray-600 mb-6">Enter your details to begin.</p>
                        <form id="join-form">
                            <div class="mb-4">
                                <label for="player-name" class="block text-gray-700 font-medium mb-1">Your Name</label>
                                <input type="text" id="player-name" class="input-field" required>
                            </div>
                            <div class="mb-4">
                                <label for="player-age" class="block text-gray-700 font-medium mb-1">Age</label>
                                <input type="number" id="player-age" class="input-field" min="1" required>
                            </div>
                            <div class="mb-6">
                                <label for="player-gender" class="block text-gray-700 font-medium mb-1">Gender</label>
                                <select id="player-gender" class="input-field" required>
                                    <option value="" disabled selected>Select your gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Non-binary">Non-binary</option>
                                    <option value="Prefer not to say">Prefer not to say</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Join Game</button>
                        </form>
                    </div>
                `;
            } else if (!state.isRoundActive) {
                mainContentHTML = `
                    <div class="bg-blue-100 p-8 rounded-lg shadow-lg text-center max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold text-blue-700 mb-2">Awaiting Next Round</h2>
                        <p class="text-lg text-blue-600">Please wait for the host to start the next round.</p>
                        <div class="mt-4 text-sm text-blue-500">
                            Current Round: ${state.game.round}
                        </div>
                    </div>
                `;
            } else {
                // Show contribution form
                mainContentHTML = `
                    <div class="bg-white p-8 rounded-lg shadow-lg max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold text-center mb-4">Round ${state.game.round}</h2>
                        <div class="flex justify-between items-center mb-6">
                            <div class="text-center">
                                <p class="text-sm text-gray-500">My Group</p>
                                <p class="font-bold text-lg">${myGroup}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-500">My Endowment</p>
                                <p class="font-bold text-lg text-green-600">E = ${state.game.gameParams.e}</p>
                            </div>
                        </div>
                        <div class="mb-6 text-center">
                             <div class="flex items-center justify-center space-x-2">
                                <p class="text-lg font-medium text-gray-700">My Total Payoff:</p>
                                <p class="text-2xl font-bold text-purple-600">${state.accumulatedPayoff.toFixed(2)}</p>
                            </div>
                        </div>

                        ${myContribution === -1 ? `
                        <form id="contribution-form">
                            <div class="mb-4">
                                <label for="contribution-amount" class="block text-gray-700 font-medium mb-2">
                                    Your Contribution ($c_i$):
                                </label>
                                <input type="number" id="contribution-amount" class="input-field"
                                       min="0" max="${state.game.gameParams.e}" value="0" required>
                            </div>
                            <button type="submit" id="submit-btn" class="btn btn-primary w-full">
                                Submit Contribution
                            </button>
                        </form>
                        ` : `
                        <div class="bg-gray-100 p-6 rounded-lg text-center">
                            <p class="text-green-600 font-bold text-lg mb-2">Contribution Submitted!</p>
                            <p class="text-gray-700">You contributed: <span class="font-bold">${myContribution}</span></p>
                        </div>
                        `}
                        <div class="mt-4 p-2 text-center text-sm text-gray-400 border-t border-gray-200">
                          Your User ID: ${userId}
                        </div>
                        
                        ${!state.isRoundActive && myContribution !== -1 && state.game.round > 0 ? `
                        <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="bg-indigo-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600">Your Group's Total Pool (Prev. Round)</p>
                                <p class="font-bold text-xl">${myGroupMembers.reduce((sum, p) => sum + (p.contributions?.[state.game.round-1] || 0), 0)}</p>
                            </div>
                            <div class="bg-pink-50 p-4 rounded-lg text-center">
                                <p class="text-sm text-gray-600">Min. Pool of Other Groups (Prev. Round)</p>
                                <p class="font-bold text-xl">${calculateMinGroupTotal(groups, myGroup, state.game.round - 1)}</p>
                            </div>
                        </div>
                        <p class="mt-6 text-center text-sm text-gray-500">
                           Your round payoff is calculated as: $e - c_i + \\frac{m}{n_i}\\sum_{k=1}^{n_i}c_k - \\frac{m-1}{n_j}min\\{\\sum_{l=1}^{n_j}c_l\\}$.
                        </p>
                        ` : ``}

                    </div>
                `;
            }

            gameUI.innerHTML = `
                <div class="min-h-screen p-4 flex items-center justify-center">
                    <div class="w-full">
                        <h1 class="text-3xl font-bold mb-6 text-center">Public Goods Game</h1>
                        ${mainContentHTML}
                    </div>
                </div>
            `;

            if (!isRegistered) {
                document.getElementById('join-form').addEventListener('submit', joinGame);
            } else if (myContribution === -1) {
                document.getElementById('contribution-form').addEventListener('submit', submitContribution);
            }
        }

        // --- Game Logic Functions ---
        async function joinGame(event) {
            event.preventDefault();
            const name = document.getElementById('player-name').value;
            const age = parseInt(document.getElementById('player-age').value, 10);
            const gender = document.getElementById('player-gender').value;

            if (!name || !age || !gender) {
                showAlert('Error', 'Please enter your name, age, and gender.');
                return;
            }
            if (!userId) {
                showAlert('Error', 'Authentication not complete. Please wait a moment and try again.');
                return;
            }
            try {
                // Get the current list of players to find the best group
                const playersColRef = collection(db, `/artifacts/${appId}/public/data/players`);
                const querySnapshot = await getDocs(playersColRef);
                const allPlayers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const groups = groupBy(allPlayers, 'group');
                const groupSizes = Object.keys(groups).map(groupName => ({
                    name: groupName,
                    size: groups[groupName].length
                }));

                const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${state.gameId}`);
                const gameDocSnap = await getDoc(gameDocRef);
                const gameData = gameDocSnap.data();
                const groupSize = gameData.gameParams.groupSize;

                // Find the group with the minimum number of players that is not full
                let targetGroup = null;
                const availableGroups = groupSizes.filter(g => g.size < groupSize);

                if (availableGroups.length > 0) {
                    // Sort by size ascending and pick the first one
                    availableGroups.sort((a, b) => a.size - b.size);
                    targetGroup = availableGroups[0].name;
                } else {
                    // Create a new group if all are full or no groups exist
                    const newGroupId = `Group_${groupSizes.length + 1}`;
                    targetGroup = newGroupId;
                }

                const playerDocRef = doc(db, `/artifacts/${appId}/public/data/players/${userId}`);
                await setDoc(playerDocRef, {
                    name,
                    age,
                    gender,
                    group: targetGroup,
                    accumulatedPayoff: 0,
                    contributions: {},
                    payoffs: {}
                });
            } catch (error) {
                console.error("Error joining game:", error);
                showAlert('Error', `Failed to join game: ${error.message}`);
            }
        }

        async function submitContribution(event) {
            event.preventDefault();
            const contribution = document.getElementById('contribution-amount').value;
            const contributionNum = Number(contribution); // Convert input to number
            
            // Check for integer contribution
            if (!Number.isInteger(contributionNum)) {
                showAlert('Invalid Contribution', 'Please enter a whole number.');
                return;
            }

            const endowment = state.game.gameParams.e;

            if (isNaN(contributionNum) || contributionNum < 0 || contributionNum > endowment) {
                showAlert('Invalid Contribution', `Please enter a value between 0 and ${endowment}.`);
                return;
            }
            if (!userId) {
                showAlert('Error', 'Authentication not complete. Please wait a moment and try again.');
                return;
            }

            try {
                const playerDocRef = doc(db, `/artifacts/${appId}/public/data/players/${userId}`);
                await setDoc(playerDocRef, {
                    contributions: {
                        [state.game.round]: contributionNum
                    }
                }, { merge: true });

            } catch (error) {
                console.error("Error submitting contribution:", error);
                showAlert('Error', `Failed to submit contribution: ${error.message}`);
            }
        }

        async function startRound() {
            if (!userId) {
                showAlert('Error', 'Authentication not complete. Please wait a moment and try again.');
                return;
            }
            const gameData = state.game;
            const playersColRef = collection(db, `/artifacts/${appId}/public/data/players`);
            const playersSnapshot = await getDocs(playersColRef);
            const totalPlayers = playersSnapshot.docs.length;
            const groupSize = gameData.gameParams.groupSize;

            if (totalPlayers % groupSize !== 0) {
                showAlert('Cannot Start Game', 'The total number of players must be a multiple of the group size to start the game.');
                return;
            }
            
            try {
                const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${state.gameId}`);
                await setDoc(gameDocRef, {
                    isRoundActive: true,
                    round: state.game.round + 1
                }, { merge: true });

                showAlert('Round Started', `Round ${state.game.round + 1} has begun!`);
            } catch (error) {
                console.error("Error starting round:", error);
                showAlert('Error', `Failed to start round: ${error.message}`);
            }
        }
        
        async function saveGameParams() {
            if (!userId) {
                showAlert('Error', 'Authentication not complete. Please wait a moment and try again.');
                return;
            }
            try {
                const endowment = parseInt(document.getElementById('param-e').value, 10);
                const multiplier = parseFloat(document.getElementById('param-m').value);
                const groupSize = parseInt(document.getElementById('param-group-size').value, 10);

                if (isNaN(endowment) || endowment <= 0 || isNaN(multiplier) || multiplier <= 0 || isNaN(groupSize) || groupSize < 2) {
                    showAlert('Invalid Parameters', 'Endowment, Multiplier, and Group Size must be positive numbers. Group Size must be at least 2.');
                    return;
                }

                const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${state.gameId}`);
                await setDoc(gameDocRef, {
                    gameParams: { e: endowment, m: multiplier, groupSize: groupSize }
                }, { merge: true });
                showAlert('Parameters Saved', 'Game parameters have been updated for the next round.');
            } catch (error) {
                console.error("Error saving game parameters:", error);
                showAlert('Error', `Failed to save parameters: ${error.message}`);
            }
        }

        async function endRound() {
            if (!userId) {
                showAlert('Error', 'Authentication not complete. Please wait a moment and try again.');
                return;
            }
            try {
                const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${state.gameId}`);
                await setDoc(gameDocRef, { isRoundActive: false }, { merge: true });

                const playersColRef = collection(db, `/artifacts/${appId}/public/data/players`);
                const querySnapshot = await getDocs(playersColRef);
                const allPlayers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Group players and calculate group totals
                const groups = groupBy(allPlayers, 'group');
                const groupTotals = Object.values(groups).map(groupMembers => ({
                    groupName: groupMembers[0].group,
                    size: groupMembers.length,
                    totalContribution: groupMembers.reduce((sum, p) => sum + (p.contributions?.[state.game.round] || 0), 0)
                }));

                // Find the minimum total contribution and its group size
                let minGroupTotal = Infinity;
                let minGroupSize = 1; // Default to 1 to avoid division by zero
                for (const group of groupTotals) {
                    if (group.totalContribution < minGroupTotal) {
                        minGroupTotal = group.totalContribution;
                        minGroupSize = group.size;
                    }
                }

                // Calculate and update payoffs for each player
                for (const player of allPlayers) {
                    const myContribution = player.contributions?.[state.game.round] || 0;
                    const myGroup = groupTotals.find(g => g.groupName === player.group);
                    
                    // Check if player's group exists to prevent errors
                    if (!myGroup) {
                        console.error(`Player ${player.id} does not belong to a valid group.`);
                        continue;
                    }
                    
                    const myGroupTotal = myGroup.totalContribution;
                    const myGroupSize = myGroup.size;

                    // Payoff formula: Πi = e - ci + (m/ni) * Σck - (m-1/nj) * min(Σcl)
                    // The 'nj' is the size of the group with the minimum contribution.
                    // The `minGroupTotal` is the total contribution of that group.
                    const payoff = state.game.gameParams.e - myContribution +
                        (state.game.gameParams.m / myGroupSize) * myGroupTotal -
                        (state.game.gameParams.m - 1) / minGroupSize * minGroupTotal;

                    const playerDocRef = doc(db, `/artifacts/${appId}/public/data/players/${player.id}`);
                    await setDoc(playerDocRef, {
                        accumulatedPayoff: player.accumulatedPayoff + payoff,
                        payoffs: {
                            [state.game.round]: payoff
                        }
                    }, { merge: true });
                }

                showAlert('Round Ended', `Payoffs for round ${state.game.round} have been calculated.`);

            } catch (error) {
                console.error("Error ending round:", error);
                showAlert('Error', `Failed to end round: ${error.message}`);
            }
        }


        async function resetGame() {
            if (!userId) {
                showAlert('Error', 'Authentication not complete. Please wait a moment and try again.');
                return;
            }
            showAlert('Confirm Reset', 'Are you sure you want to reset the game? This will delete all player data and game history.', () => confirmReset());
        }

        async function confirmReset() {
            try {
                const playersColRef = collection(db, `/artifacts/${appId}/public/data/players`);
                const querySnapshot = await getDocs(playersColRef);
                const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);

                const gameDocRef = doc(db, `/artifacts/${appId}/public/data/games/${state.gameId}`);
                await setDoc(gameDocRef, {
                    round: 0,
                    isRoundActive: false
                }, { merge: true });

                showAlert('Game Reset', 'The game has been reset successfully.');
            } catch (error) {
                console.error("Error resetting game:", error);
                showAlert('Error', `Failed to reset game: ${error.message}`);
            }
        }


        // --- Utility Functions ---
        function groupBy(array, key) {
            return array.reduce((result, currentValue) => {
                (result[currentValue[key]] = result[currentValue[key]] || []).push(
                    currentValue
                );
                return result;
            }, {});
        }

        function calculateMinGroupTotal(groups, myGroup = null, round = state.game.round) {
            const groupTotals = [];
            for (const groupName in groups) {
                if (groupName !== myGroup) {
                    const total = groups[groupName].reduce((sum, p) => sum + (p.contributions?.[round] || 0), 0);
                    groupTotals.push(total);
                }
            }
            return groupTotals.length > 0 ? Math.min(...groupTotals) : 0;
        }

        function showAlert(title, message, onConfirm = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalContainer.classList.remove('hidden');

            modalConfirmBtn.onclick = () => {
                modalContainer.classList.add('hidden');
                if (onConfirm) {
                    onConfirm();
                }
            };
        }

        // Initialize on window load
        window.onload = initializeFirebase;
    </script>
</body>

</html>
